<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Fetch method sample</title>
    <!-- Activate IE9 document mode, if available. -->
    <!-- If missing, the WebBrowser control on Windows runs in default IE8 mode which is not supported by JSBridge. -->
    <meta http-equiv='X-UA-Compatible' content='IE=edge' />
    <!-- Defined iOS viewport -->
    <!-- If missing, the UIWebView control on iOS zooms out the web page and allows the pinch zoom. -->
    <meta name='viewport' content='initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no'>
    <script type="text/javascript" src="JSBridge.js"></script>
</head>
<body>
    <script>
        function executeFromXml(resultFormat) {
            var xmlFetch = "<fetch resultformat='" + resultFormat + "' aggregate='false'>" +
                                           "<entity name='salesorder'>" +
                                               "<attribute name='name' />" +
                                               "<attribute name='shipto_city' />" +
                                               "<attribute name='shipto_line1' />" +
                                               "<attribute name='totalamount' />" +
                                                   "<filter>" +
                                                       "<condition attribute='name' operator='like' value='Bike%'  />" +
                                                       "<condition attribute='totalamount' operator='gt' value='1500'  />" +
                                                   "</filter>" +
                                           "</entity>" +
                                       "</fetch>";

            MobileCRM.FetchXml.Fetch.executeFromXML(xmlFetch, function (result) {
                if (result.length < 1) {
                    MobileCRM.bridge.alert("Not any order begins with 'Bike' and total amount grater than 1500 was found");
                }
                else {
                    var info = "Info [Missing ship - to address]: \n";
                    switch (resultFormat) {
                        case fetchResultFormat.Array:
                            for (var i in result) {
                                var entity = result[i];
                                /// Append orders what doesn't have filled 'ship to address' to info message
                                /// indexes are ordered by attributes in xml
                                var shipToCity = entity[1];
                                var shipToAddress = entity[2];
                                if (!(shipToAddress && shipToCity))
                                    info += "\nName: " + entity[0] + " Total amount: " + entity[3];
                            }
                            break;
                        case fetchResultFormat.JSON:
                            for (var i in result) {
                                /// Deserialize json object
                                var entity = result[i];
                                var shipToCity = entity.shipto_city;
                                var shipToAddress = entity.shipto_line1;
                                if (!(shipToAddress && shipToCity))
                                    info += "\nName: " + entity.name + " Total amount: " + entity.totalamount;
                            }
                            break;
                        default: //fetchResultFormat.DynamicEntities
                            for (var i in result) {
                                /// Deserialize json object
                                var entity = result[i];
                                var shipToCity = entity.properties.shipto_city;
                                var shipToAddress = entity.properties.shipto_line1;
                                if (!(shipToAddress && shipToCity))
                                    info += "\nName: " + entity.primaryName + " Total amount: " + entity.properties.totalamount;
                            }
                            break;
                    }
                    MobileCRM.bridge.alert(info);
                }
            }, MobileCRM.bridge.alert, null);
        }
        function fetchAppointments(online) {
            var starDate = new Date("January,28 2019 11:00");
            var endDate = new Date("February,30 2019 11:00");
            var entity = new MobileCRM.FetchXml.Entity('appointment');
            // add all attributes to fetch
            entity.addAttributes();
            // get activity attribute to set group by
            var activity = new MobileCRM.FetchXml.Attribute("activityid");
            entity.attributes.push(activity);
            activity.groupby = true;
            activity.alias = "activity";
            var mainFIlter2 = new MobileCRM.FetchXml.Filter();
            mainFIlter2.type = "or";
            var cnd2 = new MobileCRM.FetchXml.Condition();
            cnd2.attribute = "address_city1";
            cnd2.operator = "like";
            cnd2.values = ["Boston", "Cape-code"];
            mainFIlter2.conditions.push(cnd2);
            // === Create filter for data ===
            var dates = new Array();
            dates.push(starDate, endDate);
            var filter = new MobileCRM.FetchXml.Filter();
            filter.type = "and";
            var betweenCondition = new MobileCRM.FetchXml.Condition();
            betweenCondition.attribute = 'scheduledstart';
            betweenCondition.operator = 'between';
            betweenCondition.values = dates;
            var priorityCondition = new MobileCRM.FetchXml.Condition();
            priorityCondition.operator = "eq";
            priorityCondition.attribute = "prioritycode";
            priorityCondition.value = "1";
            filter.conditions.push(priorityCondition, betweenCondition);
            entity.filter = new MobileCRM.FetchXml.Filter();
            entity.filter.filters.push(filter);
            var fetch = new MobileCRM.FetchXml.Fetch(entity);
            fetch.aggregate = true;

            var emptyResultInfo = "Not suitable appointment with address Boston or Cape-Code between January,28 2019 11:00 - February,30 2019 11:00 was found."

            if (online) {
                fetch.executeOnline("DynamicEntities", function (res) {
                    if (res.length < 1) {
                        MobileCRM.bridge.alert(emptyResultInfo);
                    }
                    else {
                        var info = "Appointments: ";
                        for (var i in res) {
                            info += "\n Name: " + res[i].properties.subject;
                        }
                        MobileCRM.bridge.alert(info);
                    }
                }, MobileCRM.bridge.alert, null);
            }
            else
                fetch.executeOffline("DynamicEntities", function (res) {
                    if (res.length < 1) {
                        MobileCRM.bridge.alert(emptyResultInfo);
                    }
                    else {
                        var info = "Appointments: ";
                        for (var i in res) {
                            info += "\n Name: " + res[i].properties.subject;
                        }
                        MobileCRM.bridge.alert(info);
                    }
                }, MobileCRM.bridge.alert, null);
        }

    </script>
    <h3>Welcome to sample page for fetchXml method.</h3>
    Help: <a href="https://github.com/Resconet/JSBridge">Git repository...</a>
    <br />
    <h4>Run sample</h4>
    <button onclick="executeFromXml('Array')">ExecuteXml to Array</button>
    <button onclick="executeFromXml('JSON')">ExecuteXml to Json</button>
    <button onclick="executeFromXml('DynamicEntities')">ExecuteXml to DynamicEntities</button>
    <h4>Fetch appointments</h4>
    <button onclick="fetchAppointments()">Fetch to DynamicEntities</button> <b>offline</b><br />
    <button onclick="fetchAppointments()">Fetch to DynamicEntities</button>  <b>online</b>
</body>
</html>